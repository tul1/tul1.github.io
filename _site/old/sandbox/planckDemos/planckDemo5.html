<html>
<head>
  <meta name="viewport" content="width=device-width">
  <title>solsens Bots - Planck.js</title>
</head>

<body>

<script src="../../../js/planck.js-0.1.34/dist/planck-with-testbed.js"></script>
<script src="http://192.168.5.5:8000/socket.io/socket.io.js"></script>

<script>

var client = io.connect('http://192.168.5.5:8000');
var sensFloorPosition={'x':0,'y':0};
client.on('objects-update', function(objects){
  if(objects.length>0)
    sensFloorPosition = {x:(objects[0].x*2), y:(objects[0].y-1)};
});




var step=0,trajectoryCounter=0;
var player = null;
var points = [];
var sens=-1;

planck.testbed('Collition', function(testbed) {
  var pl = planck, Vec2 = pl.Vec2, Math = pl.Math;
  var width = 16.00, height = 8.00;
  var BALL_R = 0.25;
  testbed.x = 0, testbed.y = 0;

  testbed.width = width * 1.2, testbed.height = height * 1.2;
  testbed.ratio = 100;

   var WorldDef={
    gravity : Vec2.zero(),
    allowSleep : false,
    warmStarting : true,
    continuousPhysics : true,
    subStepping : true,
    blockSolve : false,
    velocityIterations : 10,
    positionIterations : 5
  };
  
  var world = pl.World(WorldDef);

  var botFixDef = {
    friction: 0.1,
    restitution: 0.99,
    mass: 1,
    userData: 'bot'
  };
  var botBodyDef = {
    linearDamping: 0.1,
    angularDamping: 0.2
  };
  var bots=[];
  for(var i=0; i<6; i++){
    var bot = world.createDynamicBody(botBodyDef);
    bot.setBullet(true);
    var pos_y = (i%2)? BALL_R : -BALL_R;
    bot.setPosition({x: (i*2), y: pos_y});
    bot.createFixture(pl.Circle(BALL_R), botFixDef);
    //bot.createFixture(pl.SetAsBox([{0,1},{0,-1},{1,0},{-1,0}]), botFixDef);
    bot.setLinearVelocity(Vec2(-2.0, 0.0));
    bots.push(bot);
  }


  player = world.createKinematicBody();
  player.setPosition({x: -width / 4, y: 0});
  player.createFixture(pl.Circle(BALL_R), {});

  world.on('post-solve', function(contact) {
 //   console.log('post-solve');

    var fA = contact.getFixtureA(), bA = fA.getBody();
    var fB = contact.getFixtureB(), bB = fB.getBody();
    var bot = fA.getUserData() == botFixDef.userData && bA || fB.getUserData() == botFixDef.userData && bB;
//    bot.setLinearVelocity(Vec2(0.0, 0.0))

  });


  testbed.step = function() {
    points.push(sensFloorPosition);
    player.setPosition(sensFloorPosition);
    if(step==50){
      sens=sens*-1;
      for(var i=0; i<bots.length; i++)
        bots[i].setLinearVelocity(Vec2(2.0*sens, -1.0*sens));
      step=0;
    }
    if(points.length==1000)
      console.log(JSON.stringify(points));
    step++;
  };

  return world;

});


</script>


</body>

</html>