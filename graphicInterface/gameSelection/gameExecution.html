<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>        
    <meta name="viewport" content="width=1200">
    <title>Game Execution</title>
</head>

<body>

<link rel="stylesheet" href="./bootstrap-theme.min.css"/>
<link rel="stylesheet" href="./bootstrap.min.css"/>
<link rel="stylesheet" href="./gameExecution.css"/>


<div id="app">
    <div class="row" id="mainContainer">
        <div class="col-xs-3" id="generalInformation">
            <div class="panel panel-default tabContent tabContentGeneral" >
                <div class="panel-heading">
                    <span> <strong>General information</strong> </span>
                    <div class="btn-group">
                        <button 
                            style="margin-left:100px;" 
                            class="btn btn-default" 
                            id="saveGeneralInformation">
                            <i class="glyphicon glyphicon-floppy-disk"></i>
                        </button>
                        <button class="btn btn-default" id="goBack">
                            <i class="glyphicon glyphicon-log-out"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-body" style="min-height: 550;">
                    <div id="generalInformation" class="tab form-horizontal">
                        <div class="form-group row">
                            <label class="col-md-4 control-label">Game name</label>
                            <div class="col-md-8">
                                <input 
                                    class="form-control text-center input-sm" 
                                    data-toggle=""
                                    data-placement="auto top" 
                                    data-container="body" 
                                    placeholder="" 
                                    title="" 
                                    type="text" value="Traffic Game 1">
                                </input>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-4" style="position: relative; left: 10px;">Description</label>
                            <textarea 
                                class="form-control input-sm col-md-8" 
                                style="position: relative; left:15px; max-width: 200px;" 
                                rows="4" 
                                type="text">Le patient doit marche en ligne droite.
                            </textarea>
                        </div>

                        <div class="form-group row">
                            <label class="col-md-4 control-label">Category</label>
                            <div class="col-md-8">
                                <select class="form-control input-sm" data-toggle="tooltip" data-placement="top" title="">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-xs-6" id="exerciceView">
            <div class="panel panel-default">
                <div class="panel-body">
                    <button id="playButton"> Play </button>
                    <span >&nbsp;</span>
                    <button id="stopButton"> Stop </button>
                    <span>&nbsp;</span>
                    <button id="resetButton"> Reset </button>
                    <br><span>&nbsp;</span>
                    <div id="panel3d">
                        <div class="contenedor">
                            <div id="gameViewer" class="viewer" style="display: block;">
                                <br>
                                <div id="webGLViewPort" style="position: relative; left: 10px;"></div>
                                <br>
                                <div class="toolbar" style="position: relative; top: -10px;left: 530px;">
                                    View: 
                                    <button class="diagonalView">45 degrees</button>
                                    <button class="2dView">2D</button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xs-3" id="mesurements">

            <div class="panel panel-default tabContent tabContentGeneral" >
                <div class="panel-heading">
                    <span> <strong>Mesurements</strong> </span>
                    <button style="margin-left:180px;" class="btn btn-default" id="downloadData"><i class="glyphicon glyphicon-download-alt"></i></button>
                </div>
                <div class="panel-body fixed-panel" style="min-height: 550  ;">

                    <div id="averageSpeed"><strong> Average speed : </strong> <span> </span> </div> <br>
                    <div id="instantSpeed"><strong> Instant speed : </strong> <span> </span> </div> <br>
                    <div id="actualPosition"><strong> Actual position : </strong> <span> </span> </div> <br>
                    <div id="time"><strong> Time : </strong> <span></span> </div> <br>
                
                </div>
            </div>
        </div>

    </div>

</div>


<script src="./jquery.min.js"></script>
<script src="./bootstrap.min.js"></script>
<script src="http://192.168.5.5:8000/socket.io/socket.io.js"></script>
<script src="./build/three.js"></script>
<script src="./js/libs/dat.gui.min.js"></script>
<script src="./js/controls/OrbitControls.js"></script>
<script src="./js/ParametricGeometries.js"></script>
<script src="./js2/3Dfloor.js"></script>


<script type="text/javascript">

var client = io.connect('http://192.168.5.5:8000');

client.on('connect', function() {
    console.log('connected');
});


var activeTiles=[];

client.on('new-activity-on-fields', function(diffBuffer) {
    activeTiles=[];//TODO integrar este codigo a la funcion updateTile
    for (var i = 0; i < diffBuffer.length; i++) {
        var aux={
            'x': (diffBuffer[i][3]-1),
            'z': (diffBuffer[i][2]-1),
            'number': diffBuffer[i][4],
            'intensity': diffBuffer[i][5]
        }
        activeTiles.push(aux);
    }
});



var outputData=[];

$("#mesurements #averageSpeed span").text("0.00 m/s");
$("#mesurements #instantSpeed span").text("0.00 m/s");
$("#mesurements #actualPosition span").text("(0 m, 0 m)");        

var instantSpeed=0;
var actualPosition={'x':0,'y':0};
var instantSpeedCum=0;
var samples=0;

client.on('objects-update', function(objects){

    if(objects.length>0){
    	console.log(objects);
        sensFloorPosition = {'posX':(objects[0].y*80),'posZ':-(objects[0].x*80),'posY':(Math.floor(objects[0].mV*100)/100)};//TODO desharcodear esto
	//	updateNavigatorPosition({'posX':(objects[0].y*80),'posZ':-(objects[0].x*80)});
    }
    if(cronoState=="COUNTING"){
        if(objects.length>0){
            instantSpeed = Math.floor(objects[0].mV*100)/100;
            actualPosition.x = Math.floor(objects[0].x*100)/100;
            actualPosition.y = Math.floor(objects[0].y*100)/100;
        }else{
            instantSpeed = 0;
            actualPosition.x = 0;
            actualPosition.y = 0;
        }
        samples++;
        instantSpeedCum += instantSpeed;
        $("#mesurements #averageSpeed span").text(Math.floor(100*instantSpeedCum/samples)/100 + " m/s");
        $("#mesurements #instantSpeed span").text(instantSpeed + " m/s");
        $("#mesurements #actualPosition span").text("("+actualPosition.x+" m,"+actualPosition.y+" m)");
    }
});

$("#mesurements #downloadData").click(function(e){
    console.log("Downloading data");
    $("<a />", {
        "download": "data.json",
        "href" : "data:application/json," + encodeURIComponent(JSON.stringify(outputData))
      }).appendTo("body")
      .click(function() {
         $(this).remove()
      })[0].click()
    console.log(JSON.stringify(outputData));
});

var miliseconds = 0
var seconds = 0;
var minutes = 0;
var startDate = null;
var timer = null;
var cronoState="RESETED";
$("#mesurements #time span").text("00:00.000");

$("#exerciceView #playButton").click(function(e){
    console.log("Play");

    if(cronoState=="RESETED")
        startDate = new Date;
    if(cronoState=="STOPPED")
        startDate = lastDate;
    cronoState="COUNTING";

    timer = setInterval(function() {
        miliseconds = new Date - startDate;
        var milisecondsCounter=miliseconds%1000;
        if(milisecondsCounter<100){
            if(milisecondsCounter<10)
                milisecondsCounter = "00"+milisecondsCounter;
            else
                milisecondsCounter = "0"+milisecondsCounter;
        }

        seconds = Math.floor(miliseconds / 1000)%60;
        var secondsCounter = (seconds>9)? seconds : ("0"+seconds);
        minutes = Math.floor(miliseconds / 60000)%60;
        var minutesCounter = (minutes>9)? minutes : ("0"+minutes);

        var cronometer = minutesCounter + ":" + secondsCounter + "."+ milisecondsCounter;
        $("#mesurements #time span").text(cronometer);

        outputData.push({
            'instantSpeed':instantSpeed,
            'averageSpeed':Math.floor(100*instantSpeedCum/samples)/100,
            'position':{
                'x':actualPosition.x,
                'y':actualPosition.y
            },
            'time':cronometer
        });
    }, 1);
})

$("#exerciceView #stopButton").click(function(e){
    console.log("Stop");
    clearInterval(timer);
    cronoState="STOPPED";
});

$("#exerciceView #resetButton").click(function(e){
    console.log("Reset");
    clearInterval(timer);
    timer=null;
    startDate = null;
    miliseconds = 0;
    seconds = 0;
    minutes = 0;
    $("#mesurements #averageSpeed span").text("0.00 m/s");
    $("#mesurements #instantSpeed span").text("0.00 m/s");
    $("#mesurements #actualPosition span").text("(0 m, 0 m)");   
    $("#mesurements #time span").text( "00:00.000" );
    outputData=[];
    cronoState="RESETED";
    samples=0;
    clearFloor();
});


$("#generalInformation #goBack").click(function(e){
    console.log("goBack");
    window.location = "gameSelection.html";

});

$("#generalInformation #saveGeneralInformation").click(function(e){
    console.log("saveGeneralInformation");
    //TODO cargar la info en la base de datos
});


var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

camera.position.z = 100;
camera.position.y = 60;
camera.position.x = 40;
camera.lookAt(new THREE.Vector3(40,60,0));

var renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(680,460);
renderer.setClearColor( 0xFFFFFF, 1 );

$("#gameViewer #webGLViewPort").append(renderer.domElement);

var controls = new THREE.OrbitControls( camera, renderer.domElement );

var lights = [];
lights[ 0 ] = new THREE.PointLight( 0xffffff, 1, 0 );
lights[ 1 ] = new THREE.PointLight( 0xffffff, 1, 0 );

lights[ 0 ].position.set( 100, 200, 100 );
lights[ 1 ].position.set( - 100, - 200, - 100 );

scene.add( lights[ 0 ] );
scene.add( lights[ 1 ] );


var sphereMaterial = new THREE.MeshPhongMaterial( {
    color:0x000000,
    emissive:0x000000,
    side:THREE.DoubleSide, 
    shading:THREE.FlatShading
});

var lineMaterial = new THREE.LineBasicMaterial({color:0xffffff, transparent:true, opacity:0.5});
var sphere = new THREE.Object3D();
sphere.add(new THREE.LineSegments(new THREE.Geometry(), lineMaterial));
sphere.add( new THREE.Mesh( new THREE.SphereGeometry( TILE_LENGTH/8, 12, 12), sphereMaterial));
sphere.position.z = 0;
sphere.position.x = 0;
sphere.position.y = 10;

scene.add(sphere);

//TODO Esto podria hacerse con el evento dimensions 
var nX=2;
var nZ=12;
createFloor(nX,nZ);

var activeTiles=[]


var newGravityCenter={};
var gravityCenters=[];
var trajectory=[];

var sensFloorPosition={'posX':0.0,'posZ':0.0,'posY':5.0};
var oldGravityCenter={'posX':0.0,'posZ':0.0,'posY':5.0 };
var render = function () {
    requestAnimationFrame(render);
    renderer.render(scene,camera);

    var posX = 0;
    var posZ = 0;
    if(gravityCenters.length>1){
        posX = (gravityCenters[gravityCenters.length-1].posX - gravityCenters[gravityCenters.length-2].posX)*(frame+1)/MAX_STEP+gravityCenters[gravityCenters.length-2].posX;
        posZ = (gravityCenters[gravityCenters.length-1].posZ - gravityCenters[gravityCenters.length-2].posZ)*(frame+1)/MAX_STEP+gravityCenters[gravityCenters.length-2].posZ;               
    }
    trajectory.push(sensFloorPosition);
   
   	updateNavigatorPosition(sensFloorPosition);
    updateFloor(activeTiles);

};


function updateNavigatorPosition(pos){
//	console.log(pos);
    sphere.position.x = pos.posX;
    sphere.position.z = pos.posZ;
   //sphere.position.y = pos.posY*4 + 5;
    sphere.position.y = 5;

}


render();


</script>

</body>
