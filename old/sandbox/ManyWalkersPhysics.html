<!DOCTYPE html>
<html lang="en">
<head>
  <title>three.js webgl - animation - skinning</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <style>
    body {
      color: #000;
      font-family:Monospace;
      font-size:13px;
      text-align:center;
      background-color: #fff;
      margin: 0px;
      overflow: hidden;
    }
  </style>

  <script src="./threeJSDemos/js/Three.js"></script>
  <script src="./threeJSDemos/js/OrbitControls.js"></script>

  <script src="./threeJSDemos/js/Detector.js"></script>
  <script src="./threeJSDemos/js/dat.gui.min.js"></script>

  <script src="./threeJSDemos/js/SpeedBlendCharacter.js"></script>
  <script src="./threeJSDemos/js/CharacterController.js"></script>

  <script src="../../js/planck.js-0.1.34/dist/planck.min.js"></script>

</head>

<body>
<div id="container"></div>
<script>

// -----------------------------------------------------------------------
if ( ! Detector.webgl ) 
  Detector.addGetWebGLMessage();

window.onload = init;

var container;
var camera, scene, renderer, controls;

var light, lightOffset;
var clock = new THREE.Clock();

var isFrameStepping = false;
var timeToStep = 0;


// -----------------------------------------------------------------------

var playerPosition = {x:6,y:0,z:0};
var playerOrientationAngle = Math.PI/2;
var playerSpeed = -1.0;

var botsPosition = [{x:0,y:0,z:-0.6},{x:1,y:0,z:0.6},{x:2,y:0,z:-0.6},{x:3,y:0,z:0.6},{x:4,y:0,z:-0.6}];
var botsOrientationAngle = -Math.PI/2;
var botsSpeed = 1.0;

var player = {};
var bots = [];
var botNum = 4;

// -----------------------------------------------------------------------

var pl = planck, Vec2 = pl.Vec2, Math = pl.Math;
var WorldDef={
  gravity : Vec2.zero(),
  allowSleep : false,
  warmStarting : true,
  continuousPhysics : true,
  subStepping : true,
  blockSolve : false,
  velocityIterations : 10,
  positionIterations : 5
};

var botFixDef = {
  friction: 1000,
  restitution: 0.99,
  mass: 60,
  userData:'bot'
};

var botBodyDef = {
  linearDamping: 0.5,
  angularDamping: 0.1
};

var BALL_R = 0.35;
var world = pl.World(WorldDef);


// -----------------------------------------------------------------------
function init() {
  container = document.getElementById( 'container' );
  scene = new THREE.Scene();
  scene.fog = new THREE.Fog( 0xB0CAE1, 1000.0, 20000.0 );
  scene.add ( new THREE.AmbientLight( 0xaaaaaa ) );

  lightOffset = new THREE.Vector3( 0, 1000, 1000.0 );

  light = new THREE.DirectionalLight( 0xffffff, 1.5 );
  light.position.copy( lightOffset );

  scene.add( light );

  renderer = new THREE.WebGLRenderer( { antialias: true, alpha: false } );
  renderer.setClearColor( '#777777', 1 );
  renderer.setSize( window.innerWidth, window.innerHeight );
  renderer.autoClear = false;
  renderer.shadowMapEnabled = true;
  renderer.shadowMapType = THREE.PCFSoftShadowMap;

  container.appendChild( renderer.domElement );

  camera = new THREE.PerspectiveCamera( 45, 3, 1, 20000 );
  camera.position.set( 0.0, 1, 6 );

  controls = new THREE.OrbitControls( camera );

  loadSkeletalMeshes();
}

// -----------------------------------------------------------------------
function loadSkeletalMeshes() {
  for(var i=0; i<botNum; i++){
    var bot={};
    bots[i]=bot;
    bot.blendMesh = new THREE.SpeedBlendCharacter();
    bot.blendMesh.load( "./threeJSDemos/models/marine/marine_anims.js",dispachMeshLoadingEnd);
  }
  //todo change for the camera
  player.blendMesh = new THREE.SpeedBlendCharacter();
  player.blendMesh.load( "./threeJSDemos/models/marine/marine_anims.js",dispachMeshLoadingEnd);
}

// -----------------------------------------------------------------------
var modelLoaded=0;
function dispachMeshLoadingEnd(){
  console.log("loadingEnded");
  modelLoaded++;
  if(modelLoaded == botNum+1)
    buildScene();
}

// -----------------------------------------------------------------------
function buildScene() {
  for(var i=0; i < botNum; i++){
    bots[i].blendMesh.rotation.y = botsOrientationAngle;
    bots[i].blendMesh.scale.set(0.01,0.01,0.01);

    bots[i].blendMesh.position.x = botsPosition[i].x;
    bots[i].blendMesh.position.y = botsPosition[i].y;
    bots[i].blendMesh.position.z = botsPosition[i].z;

    bots[i].characterController = new THREE.CharacterController( bots[i].blendMesh );

    bots[i].wasImpacted = false;
    
    var bot = world.createDynamicBody(botBodyDef);
    bot.bodyID = i;
    bot.setBullet(true);
    bot.setPosition({x: botsPosition[i].x, y: botsPosition[i].z});
    bot.createFixture(pl.Circle(BALL_R), botFixDef);
    bot.setLinearVelocity(Vec2(botsSpeed, 0.0));
    bots[i].physicModel = bot;

    scene.add(bots[i].blendMesh);

    console.log(bot.myID);
  }

  player.blendMesh.rotation.y = playerOrientationAngle;
  player.blendMesh.scale.set(0.01,0.01,0.01);

  player.blendMesh.position.x = playerPosition.x;
  player.blendMesh.position.y = playerPosition.y;
  player.blendMesh.position.z = playerPosition.z;

  player.characterController = new THREE.CharacterController( player.blendMesh );

  var p = world.createKinematicBody();
  p.setPosition({x: playerPosition.x, y: playerPosition.z});
  p.createFixture(pl.Circle(BALL_R), {});
  p.setLinearVelocity(Vec2(playerSpeed, 0.0));
  player.physicModel = p;

  scene.add(player.blendMesh);

  var axisHelper = new THREE.AxisHelper( 6 );
  scene.add( axisHelper );

  update();
}


// -----------------------------------------------------------------------
function update() {
  requestAnimationFrame( update, renderer.domElement );
  var scale = 1;
  var delta = clock.getDelta();
  var stepSize = (!isFrameStepping) ? delta * scale: timeToStep;
  world.step(1 / 60);

  if ( stepSize > 0 ) {
    THREE.AnimationHandler.update( stepSize );
    for(var i=0; i<botNum; i++) {
      if(bots[i].wasImpacted == true){
        bots[i].characterController.update(0.0);
        bots[i].blendMesh.position.x = bots[i].physicModel.getPosition().x;
        bots[i].blendMesh.position.z = bots[i].physicModel.getPosition().y;
   //     bots[i].blendMesh.updateSkeletonHelper();
      }else{
        var speed = bots[i].physicModel.getLinearVelocity();
        bots[i].characterController.update( Math.abs(speed.x*0.3) );
   //     bots[i].blendMesh.updateSkeletonHelper();
      }
    }
    var speed = player.physicModel.getLinearVelocity();
    player.characterController.update( Math.abs(speed.x*0.3) );
   // player.blendMesh.updateSkeletonHelper();

  }
  timeToStep = 0;
  renderer.clear();
  renderer.render( scene, camera );
}


// -----------------------------------------------------------------------
world.on('post-solve', function(contact) {
  var fA = contact.getFixtureA(), bA = fA.getBody();
  var fB = contact.getFixtureB(), bB = fB.getBody();
  var bot = fA.getUserData() == botFixDef.userData && bA || fB.getUserData() == botFixDef.userData && bB;
  bots[bot.bodyID].wasImpacted=true;
});

</script>

</body>
</html>

